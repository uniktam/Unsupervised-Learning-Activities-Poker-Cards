<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åˆ†é¡å¤§å¸«ï¼šæ¥µé€Ÿç‰ˆ</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body {
            font-family: 'PingFang HK', 'Helvetica Neue', sans-serif;
            background-color: #f2f2f7;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* é—œéµå„ªåŒ–ï¼šç¦æ­¢æ‰€æœ‰é»˜èªè§¸æ§è¡Œç‚º (å¦‚æ»¾å‹•ã€ç¸®æ”¾) */
            touch-action: none; 
            -webkit-user-select: none;
            user-select: none;
        }

        /* --- é ‚éƒ¨å°èˆªæ¬„ --- */
        header {
            background: white;
            padding: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0; /* é˜²æ­¢è¢«æ“ å£“ */
        }

        .tab-container {
            display: flex;
            background-color: #e5e5ea;
            border-radius: 10px;
            padding: 3px;
            width: 98%;
            max-width: 600px;
        }

        .tab-btn {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: #8e8e93;
            cursor: pointer;
            border-radius: 8px;
        }

        .tab-btn.active {
            background-color: white;
            color: #007aff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tab-btn.review-mode { color: #ff9500; }
        .tab-btn.review-mode.active { background-color: #ff9500; color: white; }

        #instruction-text {
            margin-top: 5px;
            font-size: 12px;
            color: #666;
            height: 16px;
        }

        /* --- éŠæˆ²ä¸»èˆå° --- */
        #game-container {
            flex: 1;
            position: relative;
            background-color: #35654d;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- åˆ†é¡å€ --- */
        #zones-container {
            height: 55%;
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 15px;
            box-sizing: border-box;
            background: rgba(0,0,0,0.05);
        }

        .drop-zone {
            width: 23%;
            height: 90%;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 10px;
            position: relative;
            background-color: rgba(255,255,255,0.05);
            transition: background-color 0.2s; /* ç¸®çŸ­éæ¸¡æ™‚é–“ */
        }
        
        .drop-zone::after {
            content: attr(data-label);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            color: rgba(255,255,255,0.15);
            font-weight: bold;
            pointer-events: none;
        }

        .drop-zone.hovered {
            background-color: rgba(255,255,255,0.3);
            border-color: #fff;
        }

        /* --- æ··äº‚å€ --- */
        #chaos-area {
            height: 45%;
            position: relative;
            width: 100%;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        /* --- å¡ç‰Œæ¨£å¼ --- */
        .card {
            width: 70px; /* æ‰‹æ©Ÿä¸Šç¨å¾®èª¿å°ä¸€é» */
            height: 96px;
            position: absolute;
            background-color: white;
            border-radius: 6px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            cursor: grab;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 12px;
            color: transparent; 
            font-weight: bold;
            /* é—œéµï¼šé–‹å•Ÿç¡¬é«”åŠ é€Ÿ */
            will-change: transform; 
            transform: translate3d(0,0,0);
        }

        .card.dragging {
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            z-index: 9999 !important;
            transition: none !important; /* æ‹–æ›³æ™‚çµ•å°ä¸èƒ½æœ‰ transition */
        }

        /* å¹³æ»‘ç§»å‹•å‹•ç•« */
        .card.smooth-move {
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        /* é–å®šæ¨¡å¼ */
        .locked .card { pointer-events: none; }

        /* --- åº•éƒ¨æŒ‰éˆ• --- */
        footer {
            background: white;
            padding: 10px;
            display: flex;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        button.action-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            background-color: #ff3b30; color: white;
        }
        button.action-btn:active { transform: scale(0.95); }

    </style>
</head>
<body>

<header>
    <div class="tab-container">
        <button class="tab-btn active" onclick="switchMode(1)">æ–¹æ³• 1</button>
        <button class="tab-btn" onclick="switchMode(2)">æ–¹æ³• 2</button>
        <button class="tab-btn" onclick="switchMode(3)">æ–¹æ³• 3</button>
        <button class="tab-btn review-mode" onclick="switchMode(4)">ğŸ¤ å±•ç¤º</button>
    </div>
    <div id="instruction-text">æ­£åœ¨é€²è¡Œï¼šåˆ†é¡æ–¹æ³• 1</div>
</header>

<div id="game-container">
    <div id="zones-container">
        <div class="drop-zone" id="zone-0" data-label="A"></div>
        <div class="drop-zone" id="zone-1" data-label="B"></div>
        <div class="drop-zone" id="zone-2" data-label="C"></div>
        <div class="drop-zone" id="zone-3" data-label="D"></div>
    </div>
    <div id="chaos-area"></div>
</div>

<footer>
    <button class="action-btn" id="reset-btn" onclick="resetCurrentMode()">ğŸ”„ é‡ç½®æœ¬é </button>
    <div id="presentation-controls" style="display:none; color:#333; font-weight:bold; font-size:14px;">
        é»æ“Šä¸Šæ–¹åˆ†é åˆ‡æ›å±•ç¤º
    </div>
</footer>

<script>
    /* --- 1. æ•¸æ“šèˆ‡ç‹€æ…‹ --- */
    const cardData = [
        { id: 'c9',  suit: 'c', number: 9,  name: 'æ¢…èŠ±9' },
        { id: 'ca',  suit: 'c', number: 1,  name: 'æ¢…èŠ±A' },
        { id: 'c8',  suit: 'c', number: 8,  name: 'æ¢…èŠ±8' },
        { id: 's9',  suit: 's', number: 9,  name: 'é»‘æ¡ƒ9' },
        { id: 's10', suit: 's', number: 10, name: 'é»‘æ¡ƒ10' },
        { id: 's8',  suit: 's', number: 8,  name: 'é»‘æ¡ƒ8' },
        { id: 'da',  suit: 'd', number: 1,  name: 'æ–¹å¡ŠA' },
        { id: 'd9',  suit: 'd', number: 9,  name: 'æ–¹å¡Š9' },
        { id: 'd10', suit: 'd', number: 10, name: 'æ–¹å¡Š10' },
        { id: 'd8',  suit: 'd', number: 8,  name: 'æ–¹å¡Š8' },
        { id: 'h9',  suit: 'h', number: 9,  name: 'ç´…å¿ƒ9' },
        { id: 'h10', suit: 'h', number: 10, name: 'ç´…å¿ƒ10' }
    ];

    const chaosArea = document.getElementById('chaos-area');
    const zones = document.querySelectorAll('.drop-zone');
    const instructionText = document.getElementById('instruction-text');
    let cardsElements = [];
    let currentMode = 1; 

    // å­˜å„²çµæ§‹: { 1: { 'c9': 'zone-0', ... }, ... }
    let savedStates = { 1: {}, 2: {}, 3: {} };
    // å­˜å„²å…·é«”åæ¨™ (x, y, rotation)ï¼Œç¢ºä¿åˆ‡æ›æ™‚ä½ç½®ç²¾æº–
    // { 1: { 'c9': {x:10, y:20, r:5}, ... }, ... }
    let savedPositions = { 1: {}, 2: {}, 3: {} };

    let hasInitialized = { 1: false, 2: false, 3: false };

    /* --- 2. åˆå§‹åŒ– --- */
    function init() {
        chaosArea.innerHTML = '';
        cardsElements = [];

        cardData.forEach((data) => {
            const el = document.createElement('div');
            el.classList.add('card', 'smooth-move');
            el.id = data.id;
            
            const imgPath = `images/${data.suit}_${data.number}.png`;
            el.style.backgroundImage = `url('${imgPath}')`;
            el.innerText = data.name;
            
            // åœ–ç‰‡å¤±æ•—è™•ç†
            const img = new Image();
            img.src = imgPath;
            img.onerror = () => {
                el.style.backgroundImage = 'none';
                el.style.backgroundColor = '#fff';
                el.style.color = '#333';
                el.style.border = '1px solid #999';
            };

            // åˆå§‹åŒ–æ•¸æ“š
            el.dataset.zone = "null"; 
            
            // åˆå§‹è®Šæ› (ä½¿ç”¨ transform ä»£æ›¿ top/left)
            el.style.transform = `translate3d(0px, 0px, 0) rotate(0deg)`;

            chaosArea.appendChild(el);
            cardsElements.push(el);
            
            // ç¶å®šå„ªåŒ–å¾Œçš„æ‹–æ›³äº‹ä»¶
            addOptimizedDrag(el);
        });

        resetCurrentMode(); 
        hasInitialized[1] = true;
    }

    /* --- 3. æ¨¡å¼åˆ‡æ› --- */
    function switchMode(newMode) {
        if (currentMode === newMode) return;

        if (currentMode !== 4) saveState(currentMode);

        document.querySelectorAll('.tab-btn').forEach((btn, index) => {
            btn.classList.remove('active');
            if (index + 1 === newMode) btn.classList.add('active');
        });

        currentMode = newMode;
        const container = document.getElementById('game-container');
        const resetBtn = document.getElementById('reset-btn');
        const presentationCtrl = document.getElementById('presentation-controls');

        if (newMode === 4) {
            instructionText.innerText = "ğŸ¤ å±•ç¤ºæ¨¡å¼ï¼šåˆ‡æ›ä¸Šæ–¹æŒ‰éˆ•å±•ç¤ºä½ çš„æ€è·¯";
            container.classList.add('locked');
            resetBtn.style.display = 'none';
            presentationCtrl.style.display = 'block';
            loadState(1); // é è¨­å±•ç¤ºæ–¹æ³•1
        } else {
            instructionText.innerText = `æ­£åœ¨é€²è¡Œï¼šåˆ†é¡æ–¹æ³• ${newMode}`;
            container.classList.remove('locked');
            resetBtn.style.display = 'block';
            presentationCtrl.style.display = 'none';

            if (hasInitialized[newMode]) {
                loadState(newMode);
            } else {
                resetCurrentMode();
                hasInitialized[newMode] = true;
            }
        }
    }

    function saveState(mode) {
        // ä¿å­˜å€åŸŸæ­¸å±¬å’Œå…·é«”ä½ç½® (translate X, Y)
        savedPositions[mode] = {};
        cardsElements.forEach(el => {
            savedStates[mode][el.id] = el.dataset.zone;
            
            // è§£æç•¶å‰çš„ transform çŸ©é™£æœ‰é»è¤‡é›œï¼Œ
            // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘ä¾è³´ refreshBoardLayout é‡æ–°è¨ˆç®—ä½ç½®ï¼Œ
            // åªéœ€è¦å­˜å„² zone å³å¯ã€‚å¦‚æœéœ€è¦ç²¾ç¢ºè¨˜æ†¶æ‰‹å‹•å¾®èª¿çš„ä½ç½®ï¼Œé‚è¼¯æœƒè®Šå¾—æ›´é‡ã€‚
            // ç‚ºäº†æµæš¢åº¦ï¼Œé€™è£¡æ¡å–ã€Œæ ¹æ“š Zone é‡æ–°æ’åˆ—ã€çš„ç­–ç•¥ã€‚
        });
    }

    function loadState(mode) {
        const state = savedStates[mode];
        if (!state) return;

        cardsElements.forEach(el => {
            const zone = state[el.id];
            el.dataset.zone = zone ? zone : "null";
        });
        refreshBoardLayout();
    }

    /* --- 4. ä½ˆå±€è¨ˆç®— (ä½¿ç”¨ translate3d) --- */
    function refreshBoardLayout() {
        const areaW = chaosArea.offsetWidth - 70;
        const areaH = chaosArea.offsetHeight - 96;

        // 1. è™•ç†æœªåˆ†é¡å¡ç‰Œ (éš¨æ©Ÿä½ç½®)
        // ç‚ºäº†é¿å…æ¯æ¬¡åˆ‡æ›å›ä¾†äº‚è·‘ï¼Œå¯ä»¥ä½¿ç”¨å½éš¨æ©Ÿï¼Œä½†é€™è£¡ç°¡å–®è™•ç†
        cardsElements.forEach(el => {
            if (el.dataset.zone === "null") {
                const rX = Math.random() * areaW;
                const rY = Math.random() * areaH;
                const rR = Math.random() * 30 - 15;
                setTransform(el, rX, rY, rR);
            }
        });

        // 2. è™•ç†å·²åˆ†é¡å¡ç‰Œ (æ•´é½Šæ’åˆ—)
        [0, 1, 2, 3].forEach(idx => arrangeZone(idx));
    }

    function arrangeZone(zoneIndex) {
        const zone = zones[zoneIndex];
        const zoneRect = zone.getBoundingClientRect();
        const containerRect = chaosArea.getBoundingClientRect(); 

        const cardsInZone = cardsElements.filter(c => c.dataset.zone == zoneIndex);
        
        const cardW = 70; // é…åˆ CSS
        const xOffset = (zoneRect.width - cardW) / 2;
        const startY = 10;
        const yStep = 25; // å †ç–Šé–“è·

        cardsInZone.forEach((card, index) => {
            // è¨ˆç®—ç›¸å°æ–¼ chaos-area çš„ä½ç½®
            const targetX = (zoneRect.left - containerRect.left) + xOffset;
            const targetY = (zoneRect.top - containerRect.top) + startY + (index * yStep);
            
            setTransform(card, targetX, targetY, 0, 100 + index);
        });
    }

    // å°è£è®Šæ›å‡½æ•¸ï¼Œçµ±ä¸€ä½¿ç”¨ GPU åŠ é€Ÿ
    function setTransform(el, x, y, deg, zIndex = null) {
        el.style.transform = `translate3d(${x}px, ${y}px, 0) rotate(${deg}deg)`;
        if (zIndex !== null) el.style.zIndex = zIndex;
        // å„²å­˜ç•¶å‰åæ¨™ä¾›æ‹–æ›³ä½¿ç”¨
        el.dataset.x = x;
        el.dataset.y = y;
    }

    function resetCurrentMode() {
        cardsElements.forEach(el => el.dataset.zone = "null");
        refreshBoardLayout();
    }

    /* --- 5. å„ªåŒ–çš„æ‹–æ›³é‚è¼¯ (æ ¸å¿ƒ) --- */
    function addOptimizedDrag(el) {
        let startX = 0, startY = 0;
        let initialCardX = 0, initialCardY = 0;
        let isDragging = false;

        // è§¸æ§é–‹å§‹
        const onStart = (e) => {
            if (document.getElementById('game-container').classList.contains('locked')) return;

            // ç²å–è§¸æ§é»
            const point = e.touches ? e.touches[0] : e;
            startX = point.clientX;
            startY = point.clientY;

            // è®€å–ç•¶å‰å¡ç‰Œä½ç½® (å¾ dataset æˆ–è¨ˆç®— style)
            // æ³¨æ„ï¼šå› ç‚ºæˆ‘å€‘ç”¨ translate3dï¼ŒoffsetTop/Left æ°¸é æ˜¯ 0 (å¦‚æœ CSS æ²’è¨­ top/left)
            // æ‰€ä»¥å¿…é ˆä¾è³´ dataset.x/y è¨˜éŒ„çš„ç‹€æ…‹
            initialCardX = parseFloat(el.dataset.x) || 0;
            initialCardY = parseFloat(el.dataset.y) || 0;

            isDragging = true;
            
            // è¦–è¦ºæ•ˆæœ
            el.classList.remove('smooth-move'); // é—œé–‰å‹•ç•«ä»¥è·Ÿéš¨æ‰‹æŒ‡
            el.classList.add('dragging');
            el.style.zIndex = 9999;
        };

        // è§¸æ§ç§»å‹•
        const onMove = (e) => {
            if (!isDragging) return;
            // e.preventDefault() ç”± touch-action: none è™•ç†ï¼Œé€™è£¡ä¸éœ€è¦èª¿ç”¨ï¼Œç¯€çœæ€§èƒ½
            
            const point = e.touches ? e.touches[0] : e;
            const deltaX = point.clientX - startX;
            const deltaY = point.clientY - startY;

            const newX = initialCardX + deltaX;
            const newY = initialCardY + deltaY;

            // ç›´æ¥æ›´æ–° GPU è®Šæ›
            el.style.transform = `translate3d(${newX}px, ${newY}px, 0) scale(1.1)`;
            
            // ç°¡å–®çš„ç¢°æ’æª¢æ¸¬ (Throttle ç¯€æµå¯ä»¥é€²ä¸€æ­¥å„ªåŒ–ï¼Œä½†åœ¨ç¾ä»£æ‰‹æ©Ÿä¸Šé€™å€‹ç°¡å–®è¨ˆç®—é‚„å¥½)
            // ç‚ºäº†ä¸å¡é “ï¼Œé€™è£¡ä¸æ“ä½œ DOM classï¼Œåªè¨ˆç®—
        };

        // è§¸æ§çµæŸ
        const onEnd = (e) => {
            if (!isDragging) return;
            isDragging = false;
            
            el.classList.remove('dragging');
            el.classList.add('smooth-move'); // é–‹å•Ÿå‹•ç•«ä»¥é€²è¡Œå¸é™„

            // ç²å–æœ€çµ‚æ‰‹æŒ‡ä½ç½®ä¾†åˆ¤æ–·è½é» (éœ€è¦ç”¨ changedTouches)
            // æˆ–è€…ç›´æ¥ç”¨æœ€å¾Œä¸€æ¬¡ move çš„ä½ç½®ã€‚é€™è£¡æˆ‘å€‘ç”¨å…ƒç´ ä¸­å¿ƒé»åˆ¤æ–·
            const rect = el.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const oldZone = el.dataset.zone;
            const newZone = getDroppedZoneIndex(centerX, centerY);

            if (newZone !== null) {
                el.dataset.zone = newZone;
                arrangeZone(newZone); // æ’åˆ—æ–°å®¶
            } else {
                el.dataset.zone = "null";
                // è¨ˆç®—ç•¶å‰ç›¸å°æ–¼å®¹å™¨çš„ä½ç½®ï¼Œé¿å…è·³å›åŸé»
                // ç”±æ–¼æˆ‘å€‘ä¸€ç›´æ›´æ–°çš„æ˜¯ translate3dï¼Œç¾åœ¨éœ€è¦æŠŠæœ€å¾Œçš„ä½ç½®"å®š"ä¸‹ä¾†
                // æˆ–è€…ç°¡å–®é»ï¼šçµ¦å€‹éš¨æ©Ÿæ—‹è½‰ï¼Œä½ç½®ä¿æŒåœ¨æœ€å¾Œæ”¾é–‹çš„åœ°æ–¹(å¦‚æœä¸å‡ºç•Œ)
                // ç‚ºäº†æ•™å­¸æ•´æ½”ï¼Œæˆ‘å€‘é‚„æ˜¯è®“å®ƒç¨å¾®"å¸é™„"åœ¨åŸåœ°ä½†æ“ºæ­£
                
                // é€™è£¡éœ€è¦åç®—ç›¸å°æ–¼ chaosArea çš„ x,y
                const containerRect = chaosArea.getBoundingClientRect();
                const relX = rect.left - containerRect.left;
                const relY = rect.top - containerRect.top;
                
                // æ›´æ–° dataset
                const rR = Math.random() * 20 - 10;
                setTransform(el, relX, relY, rR, Math.floor(Math.random()*10));
            }

            // å¦‚æœé›¢é–‹äº†èˆŠå€åŸŸï¼ŒèˆŠå€åŸŸé‡æ’
            if (oldZone !== "null" && oldZone != newZone) {
                arrangeZone(oldZone);
            }
            
            // æ¸…é™¤é«˜äº®
            zones.forEach(z => z.classList.remove('hovered'));
        };

        // ç¶å®šäº‹ä»¶
        el.addEventListener('touchstart', onStart, { passive: false });
        el.addEventListener('touchmove', onMove, { passive: false });
        el.addEventListener('touchend', onEnd);
        
        // å…¼å®¹æ»‘é¼ 
        el.addEventListener('mousedown', onStart);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onEnd);
    }

    function getDroppedZoneIndex(x, y) {
        let target = null;
        zones.forEach((zone, index) => {
            const r = zone.getBoundingClientRect();
            if (x > r.left && x < r.right && y > r.top && y < r.bottom) {
                target = index;
                // åªæœ‰åœ¨ end çš„æ™‚å€™æ‰åŠ æ¨£å¼ï¼Œé¿å…ç§»å‹•æ™‚é »ç¹é‡ç¹ª
                // æˆ–è€…åœ¨ move è£¡åšï¼Œä½†è¦å°å¿ƒæ€§èƒ½
            }
        });
        return target;
    }

    window.onload = init;

</script>

</body>
</html>